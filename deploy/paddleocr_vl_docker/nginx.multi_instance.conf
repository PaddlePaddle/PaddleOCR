# 示例：Nginx 负载均衡配置
# 将此文件复制为 nginx.conf 并与 compose.multi_instance.yaml.example 搭配使用

events {
    worker_connections 1024;
}

http {
    upstream paddleocr_vl_backend {
        # 采用轮询调度，将请求分发到多个 API 实例
        server paddleocr-vl-api-1:8080;
        server paddleocr-vl-api-2:8080;
        # 如有更多实例可在此处继续添加
        # server paddleocr-vl-api-3:8080;
    }

    server {
        listen 80;
        server_name _;

        # PDF 推理耗时较长，需要拉长超时时间
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        send_timeout 300s;

        # PDF/图片较大时放宽请求体限制
        client_max_body_size 100M;

        location / {
            proxy_pass http://paddleocr_vl_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 如需 WebSocket，可保持以下设置
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # 负载均衡器的 /health 直接透传到后端实例
        location /health {
            proxy_pass http://paddleocr_vl_backend/health;
        }
    }
}
