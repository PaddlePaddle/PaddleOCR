# åŸºäºPP-OCRv3çš„æ‰‹å†™æ–‡å­—è¯†åˆ«

- [1. é¡¹ç›®èƒŒæ™¯åŠæ„ä¹‰](#1-é¡¹ç›®èƒŒæ™¯åŠæ„ä¹‰)
- [2. é¡¹ç›®å†…å®¹](#2-é¡¹ç›®å†…å®¹)
- [3. PP-OCRv3è¯†åˆ«ç®—æ³•ä»‹ç»](#3-PP-OCRv3è¯†åˆ«ç®—æ³•ä»‹ç»)
- [4. å®‰è£…ç¯å¢ƒ](#4-å®‰è£…ç¯å¢ƒ)
- [5. æ•°æ®å‡†å¤‡](#5-æ•°æ®å‡†å¤‡)
- [6. æ¨¡å‹è®­ç»ƒ](#6-æ¨¡å‹è®­ç»ƒ)
  - [6.1 ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹](#61-ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹)
  - [6.2 ä¿®æ”¹é…ç½®æ–‡ä»¶](#62-ä¿®æ”¹é…ç½®æ–‡ä»¶)
  - [6.3 å¼€å§‹è®­ç»ƒ](#63-å¼€å§‹è®­ç»ƒ)
- [7. æ¨¡å‹è¯„ä¼°](#7-æ¨¡å‹è¯„ä¼°)
- [8. æ¨¡å‹å¯¼å‡ºæ¨ç†](#8-æ¨¡å‹å¯¼å‡ºæ¨ç†)
  - [8.1 æ¨¡å‹å¯¼å‡º](#81-æ¨¡å‹å¯¼å‡º)
  - [8.2 æ¨¡å‹æ¨ç†](#82-æ¨¡å‹æ¨ç†)


## 1. é¡¹ç›®èƒŒæ™¯åŠæ„ä¹‰
ç›®å‰å…‰å­¦å­—ç¬¦è¯†åˆ«(OCR)æŠ€æœ¯åœ¨æˆ‘ä»¬çš„ç”Ÿæ´»å½“ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œä½†æ˜¯å¤§å¤šæ•°æ¨¡å‹åœ¨é€šç”¨åœºæ™¯ä¸‹çš„å‡†ç¡®æ€§è¿˜æœ‰å¾…æé«˜ã€‚é’ˆå¯¹äºæ­¤æˆ‘ä»¬å€ŸåŠ©é£æ¡¨æä¾›çš„PaddleOCRå¥—ä»¶è¾ƒå®¹æ˜“çš„å®ç°äº†åœ¨å‚ç±»åœºæ™¯ä¸‹çš„åº”ç”¨ã€‚æ‰‹å†™ä½“åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­è¾ƒä¸ºå¸¸è§ï¼Œç„¶è€Œæ‰‹å†™ä½“çš„è¯†åˆ«å´å­˜åœ¨ç€å¾ˆå¤§çš„æŒ‘æˆ˜ï¼Œå› ä¸ºæ¯ä¸ªäººçš„æ‰‹å†™å­—ä½“é£æ ¼ä¸ä¸€æ ·ï¼Œè¿™å¯¹äºè§†è§‰æ¨¡å‹æ¥è¯´è¿˜æ˜¯ç›¸å½“æœ‰æŒ‘æˆ˜çš„ã€‚å› æ­¤è®­ç»ƒä¸€ä¸ªæ‰‹å†™ä½“è¯†åˆ«æ¨¡å‹å…·æœ‰å¾ˆå¥½çš„ç°å®æ„ä¹‰ã€‚ä¸‹é¢ç»™å‡ºä¸€äº›æ‰‹å†™ä½“çš„ç¤ºä¾‹å›¾ï¼š

![example](https://ai-studio-static-online.cdn.bcebos.com/7a8865b2836f42d382e7c3fdaedc4d307d797fa2bcd0466e9f8b7705efff5a7b)

## 2. é¡¹ç›®å†…å®¹
æœ¬é¡¹ç›®åŸºäºPaddleOCRå¥—ä»¶ï¼Œä»¥PP-OCRv3è¯†åˆ«æ¨¡å‹ä¸ºåŸºç¡€ï¼Œé’ˆå¯¹æ‰‹å†™æ–‡å­—è¯†åˆ«åœºæ™¯è¿›è¡Œä¼˜åŒ–ã€‚

Aistudioé¡¹ç›®é“¾æ¥ï¼š[OCRæ‰‹å†™æ–‡å­—è¯†åˆ«](https://aistudio.baidu.com/aistudio/projectdetail/4330587)

## 3. PP-OCRv3è¯†åˆ«ç®—æ³•ä»‹ç»
PP-OCRv3çš„è¯†åˆ«æ¨¡å—æ˜¯åŸºäºæ–‡æœ¬è¯†åˆ«ç®—æ³•[SVTR](https://arxiv.org/abs/2205.00159)ä¼˜åŒ–ã€‚SVTRä¸å†é‡‡ç”¨RNNç»“æ„ï¼Œé€šè¿‡å¼•å…¥Transformersç»“æ„æ›´åŠ æœ‰æ•ˆåœ°æŒ–æ˜æ–‡æœ¬è¡Œå›¾åƒçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»è€Œæå‡æ–‡æœ¬è¯†åˆ«èƒ½åŠ›ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒPP-OCRv3é‡‡ç”¨äº†6ä¸ªä¼˜åŒ–ç­–ç•¥ã€‚

![v3_rec](https://ai-studio-static-online.cdn.bcebos.com/d4f5344b5b854d50be738671598a89a45689c6704c4d481fb904dd7cf72f2a1a)

ä¼˜åŒ–ç­–ç•¥æ±‡æ€»å¦‚ä¸‹ï¼š

* SVTR_LCNetï¼šè½»é‡çº§æ–‡æœ¬è¯†åˆ«ç½‘ç»œ
* GTCï¼šAttentionæŒ‡å¯¼CTCè®­ç»ƒç­–ç•¥
* TextConAugï¼šæŒ–æ˜æ–‡å­—ä¸Šä¸‹æ–‡ä¿¡æ¯çš„æ•°æ®å¢å¹¿ç­–ç•¥
* TextRotNetï¼šè‡ªç›‘ç£çš„é¢„è®­ç»ƒæ¨¡å‹
* UDMLï¼šè”åˆäº’å­¦ä¹ ç­–ç•¥
* UIMï¼šæ— æ ‡æ³¨æ•°æ®æŒ–æ˜æ–¹æ¡ˆ

è¯¦ç»†ä¼˜åŒ–ç­–ç•¥æè¿°è¯·å‚è€ƒ[PP-OCRv3ä¼˜åŒ–ç­–ç•¥](https://github.com/PaddlePaddle/PaddleOCR/blob/release/2.5/doc/doc_ch/PP-OCRv3_introduction.md#3-%E8%AF%86%E5%88%AB%E4%BC%98%E5%8C%96)

## 4. å®‰è£…ç¯å¢ƒ


```python
# é¦–å…ˆgitå®˜æ–¹çš„PaddleOCRé¡¹ç›®ï¼Œå®‰è£…éœ€è¦çš„ä¾èµ–
git clone https://github.com/PaddlePaddle/PaddleOCR.git
cd PaddleOCR
pip install -r requirements.txt
```

## 5. æ•°æ®å‡†å¤‡
æœ¬é¡¹ç›®ä½¿ç”¨å…¬å¼€çš„æ‰‹å†™æ–‡æœ¬è¯†åˆ«æ•°æ®é›†ï¼ŒåŒ…å«Chinese OCR, ä¸­ç§‘é™¢è‡ªåŠ¨åŒ–ç ”ç©¶æ‰€-æ‰‹å†™ä¸­æ–‡æ•°æ®é›†[CASIA-HWDB2.x](http://www.nlpr.ia.ac.cn/databases/handwriting/Download.html)ï¼Œä»¥åŠç”±ä¸­ç§‘é™¢æ‰‹å†™æ•°æ®å’Œç½‘ä¸Šå¼€æºæ•°æ®åˆå¹¶ç»„åˆçš„[æ•°æ®é›†](https://aistudio.baidu.com/aistudio/datasetdetail/102884/0)ç­‰ï¼Œè¯¥é¡¹ç›®å·²ç»æŒ‚è½½å¤„ç†å¥½çš„æ•°æ®é›†ï¼Œå¯ç›´æ¥ä¸‹è½½ä½¿ç”¨è¿›è¡Œè®­ç»ƒã€‚


```python
ä¸‹è½½å¹¶è§£å‹æ•°æ®
tar -xf hw_data.tar
```

## 6. æ¨¡å‹è®­ç»ƒ
### 6.1 ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹
é¦–å…ˆéœ€è¦ä¸‹è½½æˆ‘ä»¬éœ€è¦çš„PP-OCRv3è¯†åˆ«é¢„è®­ç»ƒæ¨¡å‹ï¼Œæ›´å¤šé€‰æ‹©è¯·è‡ªè¡Œé€‰æ‹©å…¶ä»–çš„[æ–‡å­—è¯†åˆ«æ¨¡å‹](https://github.com/PaddlePaddle/PaddleOCR/blob/release/2.5/doc/doc_ch/models_list.md#2-%E6%96%87%E6%9C%AC%E8%AF%86%E5%88%AB%E6%A8%A1%E5%9E%8B)


```python
# ä½¿ç”¨è¯¥æŒ‡ä»¤ä¸‹è½½éœ€è¦çš„é¢„è®­ç»ƒæ¨¡å‹
wget -P ./pretrained_models/ https://paddleocr.bj.bcebos.com/PP-OCRv3/chinese/ch_PP-OCRv3_rec_train.tar
# è§£å‹é¢„è®­ç»ƒæ¨¡å‹æ–‡ä»¶
tar -xf ./pretrained_models/ch_PP-OCRv3_rec_train.tar -C pretrained_models
```

### 6.2 ä¿®æ”¹é…ç½®æ–‡ä»¶
æˆ‘ä»¬ä½¿ç”¨`configs/rec/PP-OCRv3/ch_PP-OCRv3_rec_distillation.yml`ï¼Œä¸»è¦ä¿®æ”¹è®­ç»ƒè½®æ•°å’Œå­¦ä¹ ç‡å‚ç›¸å…³å‚æ•°ï¼Œè®¾ç½®é¢„è®­ç»ƒæ¨¡å‹è·¯å¾„ï¼Œè®¾ç½®æ•°æ®é›†è·¯å¾„ã€‚ å¦å¤–ï¼Œbatch_sizeå¯æ ¹æ®è‡ªå·±æœºå™¨æ˜¾å­˜å¤§å°è¿›è¡Œè°ƒæ•´ã€‚ å…·ä½“ä¿®æ”¹å¦‚ä¸‹å‡ ä¸ªåœ°æ–¹ï¼š

```
  epoch_num: 100 # è®­ç»ƒepochæ•°
  save_model_dir: ./output/ch_PP-OCR_v3_rec
  save_epoch_step: 10
  eval_batch_step: [0, 100] # è¯„ä¼°é—´éš”ï¼Œæ¯éš”100stepè¯„ä¼°ä¸€æ¬¡
  pretrained_model: ./pretrained_models/ch_PP-OCRv3_rec_train/best_accuracy  # é¢„è®­ç»ƒæ¨¡å‹è·¯å¾„


  lr:
    name: Cosine # ä¿®æ”¹å­¦ä¹ ç‡è¡°å‡ç­–ç•¥ä¸ºCosine
    learning_rate: 0.0001 # ä¿®æ”¹fine-tuneçš„å­¦ä¹ ç‡
    warmup_epoch: 2 # ä¿®æ”¹warmupè½®æ•°

Train:
  dataset:
    name: SimpleDataSet
    data_dir: ./train_data # è®­ç»ƒé›†å›¾ç‰‡è·¯å¾„
    ext_op_transform_idx: 1
    label_file_list:
    - ./train_data/chineseocr-data/rec_hand_line_all_label_train.txt # è®­ç»ƒé›†æ ‡ç­¾
    - ./train_data/handwrite/HWDB2.0Train_label.txt
    - ./train_data/handwrite/HWDB2.1Train_label.txt
    - ./train_data/handwrite/HWDB2.2Train_label.txt
    - ./train_data/handwrite/hwdb_ic13/handwriting_hwdb_train_labels.txt
    - ./train_data/handwrite/HW_Chinese/train_hw.txt
    ratio_list:
    - 0.1
    - 1.0
    - 1.0
    - 1.0
    - 0.02
    - 1.0
  loader:
    shuffle: true
    batch_size_per_card: 64
    drop_last: true
    num_workers: 4
Eval:
  dataset:
    name: SimpleDataSet
    data_dir: ./train_data # æµ‹è¯•é›†å›¾ç‰‡è·¯å¾„
    label_file_list:
    - ./train_data/chineseocr-data/rec_hand_line_all_label_val.txt # æµ‹è¯•é›†æ ‡ç­¾
    - ./train_data/handwrite/HWDB2.0Test_label.txt
    - ./train_data/handwrite/HWDB2.1Test_label.txt
    - ./train_data/handwrite/HWDB2.2Test_label.txt
    - ./train_data/handwrite/hwdb_ic13/handwriting_hwdb_val_labels.txt
    - ./train_data/handwrite/HW_Chinese/test_hw.txt
  loader:
    shuffle: false
    drop_last: false
    batch_size_per_card: 64
    num_workers: 4
```
ç”±äºæ•°æ®é›†å¤§å¤šæ˜¯é•¿æ–‡æœ¬ï¼Œå› æ­¤éœ€è¦**æ³¨é‡Š**æ‰ä¸‹é¢çš„æ•°æ®å¢å¹¿ç­–ç•¥ï¼Œä»¥ä¾¿è®­ç»ƒå‡ºæ›´å¥½çš„æ¨¡å‹ã€‚
```
- RecConAug:
    prob: 0.5
    ext_data_num: 2
    image_shape: [48, 320, 3]
```


### 6.3 å¼€å§‹è®­ç»ƒ
æˆ‘ä»¬ä½¿ç”¨ä¸Šé¢ä¿®æ”¹å¥½çš„é…ç½®æ–‡ä»¶`configs/rec/PP-OCRv3/ch_PP-OCRv3_rec_distillation.yml`ï¼Œé¢„è®­ç»ƒæ¨¡å‹ï¼Œæ•°æ®é›†è·¯å¾„ï¼Œå­¦ä¹ ç‡ï¼Œè®­ç»ƒè½®æ•°ç­‰éƒ½å·²ç»è®¾ç½®å®Œæ¯•åï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤å¼€å§‹è®­ç»ƒã€‚


```python
# å¼€å§‹è®­ç»ƒè¯†åˆ«æ¨¡å‹
python tools/train.py -c configs/rec/PP-OCRv3/ch_PP-OCRv3_rec_distillation.yml

```

## 7. æ¨¡å‹è¯„ä¼°
åœ¨è®­ç»ƒä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥è¯„ä¼°é¢„è®­ç»ƒæ¨¡å‹çš„æ•ˆæœ:



```python
# è¯„ä¼°é¢„è®­ç»ƒæ¨¡å‹
python tools/eval.py -c configs/rec/PP-OCRv3/ch_PP-OCRv3_rec_distillation.yml -o Global.pretrained_model="./pretrained_models/ch_PP-OCRv3_rec_train/best_accuracy"
```
```
[2022/07/14 10:46:22] ppocr INFO: load pretrain successful from ./pretrained_models/ch_PP-OCRv3_rec_train/best_accuracy
eval model:: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 687/687 [03:29<00:00,  3.27it/s]
[2022/07/14 10:49:52] ppocr INFO: metric eval ***************
[2022/07/14 10:49:52] ppocr INFO: acc:0.03724954461811258
[2022/07/14 10:49:52] ppocr INFO: norm_edit_dis:0.4859541065843199
[2022/07/14 10:49:52] ppocr INFO: Teacher_acc:0.0371584699368947
[2022/07/14 10:49:52] ppocr INFO: Teacher_norm_edit_dis:0.48718814890536477
[2022/07/14 10:49:52] ppocr INFO: fps:947.8562684823883
```

å¯ä»¥çœ‹å‡ºï¼Œç›´æ¥åŠ è½½é¢„è®­ç»ƒæ¨¡å‹è¿›è¡Œè¯„ä¼°ï¼Œæ•ˆæœè¾ƒå·®ï¼Œå› ä¸ºé¢„è®­ç»ƒæ¨¡å‹å¹¶ä¸æ˜¯åŸºäºæ‰‹å†™æ–‡å­—è¿›è¡Œå•ç‹¬è®­ç»ƒçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŸºäºé¢„è®­ç»ƒæ¨¡å‹è¿›è¡Œfinetuneã€‚
è®­ç»ƒå®Œæˆåï¼Œå¯ä»¥è¿›è¡Œæµ‹è¯•è¯„ä¼°ï¼Œè¯„ä¼°å‘½ä»¤å¦‚ä¸‹ï¼š



```python
# è¯„ä¼°finetuneæ•ˆæœ
python tools/eval.py -c configs/rec/PP-OCRv3/ch_PP-OCRv3_rec_distillation.yml -o Global.pretrained_model="./output/ch_PP-OCR_v3_rec/best_accuracy"

```

è¯„ä¼°ç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹å‡ºè¯†åˆ«å‡†ç¡®ç‡ä¸º54.3%ã€‚
```
[2022/07/14 10:54:06] ppocr INFO: metric eval ***************
[2022/07/14 10:54:06] ppocr INFO: acc:0.5430100180913
[2022/07/14 10:54:06] ppocr INFO: norm_edit_dis:0.9203322593158589
[2022/07/14 10:54:06] ppocr INFO: Teacher_acc:0.5401183969626324
[2022/07/14 10:54:06] ppocr INFO: Teacher_norm_edit_dis:0.919827504507755
[2022/07/14 10:54:06] ppocr INFO: fps:928.948733797251
```

å¦‚éœ€è·å–å·²è®­ç»ƒæ¨¡å‹ï¼Œè¯·æ‰«ç å¡«å†™é—®å·ï¼ŒåŠ å…¥PaddleOCRå®˜æ–¹äº¤æµç¾¤è·å–å…¨éƒ¨OCRå‚ç±»æ¨¡å‹ä¸‹è½½é“¾æ¥ã€ã€ŠåŠ¨æ‰‹å­¦OCRã€‹ç”µå­ä¹¦ç­‰å…¨å¥—OCRå­¦ä¹ èµ„æ–™ğŸ
<div align="left">
<img src="https://ai-studio-static-online.cdn.bcebos.com/dd721099bd50478f9d5fb13d8dd00fad69c22d6848244fd3a1d3980d7fefc63e"  width = "150" height = "150" />
</div>
å°†ä¸‹è½½æˆ–è®­ç»ƒå®Œæˆçš„æ¨¡å‹æ”¾ç½®åœ¨å¯¹åº”ç›®å½•ä¸‹å³å¯å®Œæˆæ¨¡å‹æ¨ç†ã€‚

## 8. æ¨¡å‹å¯¼å‡ºæ¨ç†
è®­ç»ƒå®Œæˆåï¼Œå¯ä»¥å°†è®­ç»ƒæ¨¡å‹è½¬æ¢æˆinferenceæ¨¡å‹ã€‚inference æ¨¡å‹ä¼šé¢å¤–ä¿å­˜æ¨¡å‹çš„ç»“æ„ä¿¡æ¯ï¼Œåœ¨é¢„æµ‹éƒ¨ç½²ã€åŠ é€Ÿæ¨ç†ä¸Šæ€§èƒ½ä¼˜è¶Šï¼Œçµæ´»æ–¹ä¾¿ï¼Œé€‚åˆäºå®é™…ç³»ç»Ÿé›†æˆã€‚


### 8.1 æ¨¡å‹å¯¼å‡º
å¯¼å‡ºå‘½ä»¤å¦‚ä¸‹ï¼š



```python
# è½¬åŒ–ä¸ºæ¨ç†æ¨¡å‹
python tools/export_model.py -c configs/rec/PP-OCRv3/ch_PP-OCRv3_rec_distillation.yml -o Global.pretrained_model="./output/ch_PP-OCR_v3_rec/best_accuracy" Global.save_inference_dir="./inference/rec_ppocrv3/"

```

### 8.2 æ¨¡å‹æ¨ç†
å¯¼å‡ºæ¨¡å‹åï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ¨ç†é¢„æµ‹:



```python
# æ¨ç†é¢„æµ‹
python tools/infer/predict_rec.py --image_dir="train_data/handwrite/HWDB2.0Test_images/104-P16_4.jpg" --rec_model_dir="./inference/rec_ppocrv3/Student"
```

```
[2022/07/14 10:55:56] ppocr INFO: In PP-OCRv3, rec_image_shape parameter defaults to '3, 48, 320', if you are using recognition model with PP-OCRv2 or an older version, please set --rec_image_shape='3,32,320
[2022/07/14 10:55:58] ppocr INFO: Predicts of train_data/handwrite/HWDB2.0Test_images/104-P16_4.jpg:('å“ç»“æ„,å·®å¼‚åŒ–çš„å¤šå“ç‰Œæ¸—é€ä½¿æ¬§è±é›…ç¡®ç«‹äº†å…¶åœ¨ä¸­å›½åŒ–å¦†', 0.9904912114143372)
```


```python
# å¯è§†åŒ–æ–‡å­—è¯†åˆ«å›¾ç‰‡
from PIL import Image  
import matplotlib.pyplot as plt
import numpy as np
import os


img_path = 'train_data/handwrite/HWDB2.0Test_images/104-P16_4.jpg'

def vis(img_path):
    plt.figure()
    image = Image.open(img_path)  
    plt.imshow(image)
    plt.show()
    # image = image.resize([208, 208])  


vis(img_path)
```


![res](https://ai-studio-static-online.cdn.bcebos.com/ad7c02745491498d82e0ce95f4a274f9b3920b2f467646858709359b7af9d869)
