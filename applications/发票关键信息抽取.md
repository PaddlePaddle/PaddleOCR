
# åŸºäºVI-LayoutXLMçš„å‘ç¥¨å…³é”®ä¿¡æ¯æŠ½å–

- [1. é¡¹ç›®èƒŒæ™¯åŠæ„ä¹‰](#1-é¡¹ç›®èƒŒæ™¯åŠæ„ä¹‰)
- [2. é¡¹ç›®å†…å®¹](#2-é¡¹ç›®å†…å®¹)
- [3. å®‰è£…ç¯å¢ƒ](#3-å®‰è£…ç¯å¢ƒ)
- [4. å…³é”®ä¿¡æ¯æŠ½å–](#4-å…³é”®ä¿¡æ¯æŠ½å–)
  - [4.1 æ–‡æœ¬æ£€æµ‹](#41-æ–‡æœ¬æ£€æµ‹)
  - [4.2 æ–‡æœ¬è¯†åˆ«](#42-æ–‡æœ¬è¯†åˆ«)
  - [4.3 è¯­ä¹‰å®ä½“è¯†åˆ«](#43-è¯­ä¹‰å®ä½“è¯†åˆ«)
  - [4.4 å…³ç³»æŠ½å–](#44-å…³ç³»æŠ½å–)



## 1. é¡¹ç›®èƒŒæ™¯åŠæ„ä¹‰

å…³é”®ä¿¡æ¯æŠ½å–åœ¨æ–‡æ¡£åœºæ™¯ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œå¦‚èº«ä»½è¯ä¸­çš„å§“åã€ä½å€ä¿¡æ¯æŠ½å–ï¼Œå¿«é€’å•ä¸­çš„å§“åã€è”ç³»æ–¹å¼ç­‰å…³é”®å­—æ®µå†…å®¹çš„æŠ½å–ã€‚ä¼ ç»ŸåŸºäºæ¨¡æ¿åŒ¹é…çš„æ–¹æ¡ˆéœ€è¦é’ˆå¯¹ä¸åŒçš„åœºæ™¯åˆ¶å®šæ¨¡æ¿å¹¶è¿›è¡Œé€‚é…ï¼Œè¾ƒä¸ºç¹çï¼Œä¸å¤Ÿé²æ£’ã€‚åŸºäºè¯¥é—®é¢˜ï¼Œæˆ‘ä»¬å€ŸåŠ©é£æ¡¨æä¾›çš„PaddleOCRå¥—ä»¶ä¸­çš„å…³é”®ä¿¡æ¯æŠ½å–æ–¹æ¡ˆï¼Œå®ç°å¯¹å¢å€¼ç¨å‘ç¥¨åœºæ™¯çš„å…³é”®ä¿¡æ¯æŠ½å–ã€‚

## 2. é¡¹ç›®å†…å®¹

æœ¬é¡¹ç›®åŸºäºPaddleOCRå¼€æºå¥—ä»¶ï¼Œä»¥VI-LayoutXLMå¤šæ¨¡æ€å…³é”®ä¿¡æ¯æŠ½å–æ¨¡å‹ä¸ºåŸºç¡€ï¼Œé’ˆå¯¹å¢å€¼ç¨å‘ç¥¨åœºæ™¯è¿›è¡Œé€‚é…ï¼Œæå–è¯¥åœºæ™¯çš„å…³é”®ä¿¡æ¯ã€‚

## 3. å®‰è£…ç¯å¢ƒ

```bash
# é¦–å…ˆgitå®˜æ–¹çš„PaddleOCRé¡¹ç›®ï¼Œå®‰è£…éœ€è¦çš„ä¾èµ–
# ç¬¬ä¸€æ¬¡è¿è¡Œæ‰“å¼€è¯¥æ³¨é‡Š
git clone https://gitee.com/PaddlePaddle/PaddleOCR.git
cd PaddleOCR
# å®‰è£…PaddleOCRçš„ä¾èµ–
pip install -r requirements.txt
# å®‰è£…å…³é”®ä¿¡æ¯æŠ½å–ä»»åŠ¡çš„ä¾èµ–
pip install -r ./ppstructure/kie/requirements.txt
```

## 4. å…³é”®ä¿¡æ¯æŠ½å–

åŸºäºæ–‡æ¡£å›¾åƒçš„å…³é”®ä¿¡æ¯æŠ½å–åŒ…å«3ä¸ªéƒ¨åˆ†ï¼šï¼ˆ1ï¼‰æ–‡æœ¬æ£€æµ‹ï¼ˆ2ï¼‰æ–‡æœ¬è¯†åˆ«ï¼ˆ3ï¼‰å…³é”®ä¿¡æ¯æŠ½å–æ–¹æ³•ï¼ŒåŒ…æ‹¬è¯­ä¹‰å®ä½“è¯†åˆ«æˆ–è€…å…³ç³»æŠ½å–ï¼Œä¸‹é¢åˆ†åˆ«è¿›è¡Œä»‹ç»ã€‚

### 4.1 æ–‡æœ¬æ£€æµ‹


æœ¬æ–‡é‡ç‚¹å…³æ³¨å‘ç¥¨çš„å…³é”®ä¿¡æ¯æŠ½å–æ¨¡å‹è®­ç»ƒä¸é¢„æµ‹è¿‡ç¨‹ï¼Œå› æ­¤åœ¨å…³é”®ä¿¡æ¯æŠ½å–è¿‡ç¨‹ä¸­ï¼Œç›´æ¥ä½¿ç”¨æ ‡æ³¨çš„æ–‡æœ¬æ£€æµ‹ä¸è¯†åˆ«æ ‡æ³¨ä¿¡æ¯è¿›è¡Œæµ‹è¯•ï¼Œå¦‚æœä½ å¸Œæœ›è‡ªå®šä¹‰è¯¥åœºæ™¯çš„æ–‡æœ¬æ£€æµ‹æ¨¡å‹ï¼Œå®Œæˆç«¯åˆ°ç«¯çš„å…³é”®ä¿¡æ¯æŠ½å–éƒ¨åˆ†ï¼Œè¯·å‚è€ƒ[æ–‡æœ¬æ£€æµ‹æ¨¡å‹è®­ç»ƒæ•™ç¨‹](../doc/doc_ch/detection.md)ï¼ŒæŒ‰ç…§è®­ç»ƒæ•°æ®æ ¼å¼å‡†å¤‡æ•°æ®ï¼Œå¹¶å®Œæˆè¯¥åœºæ™¯ä¸‹å‚ç±»æ–‡æœ¬æ£€æµ‹æ¨¡å‹çš„å¾®è°ƒè¿‡ç¨‹ã€‚


### 4.2 æ–‡æœ¬è¯†åˆ«

æœ¬æ–‡é‡ç‚¹å…³æ³¨å‘ç¥¨çš„å…³é”®ä¿¡æ¯æŠ½å–æ¨¡å‹è®­ç»ƒä¸é¢„æµ‹è¿‡ç¨‹ï¼Œå› æ­¤åœ¨å…³é”®ä¿¡æ¯æŠ½å–è¿‡ç¨‹ä¸­ï¼Œç›´æ¥ä½¿ç”¨æä¾›çš„æ–‡æœ¬æ£€æµ‹ä¸è¯†åˆ«æ ‡æ³¨ä¿¡æ¯è¿›è¡Œæµ‹è¯•ï¼Œå¦‚æœä½ å¸Œæœ›è‡ªå®šä¹‰è¯¥åœºæ™¯çš„æ–‡æœ¬æ£€æµ‹æ¨¡å‹ï¼Œå®Œæˆç«¯åˆ°ç«¯çš„å…³é”®ä¿¡æ¯æŠ½å–éƒ¨åˆ†ï¼Œè¯·å‚è€ƒ[æ–‡æœ¬è¯†åˆ«æ¨¡å‹è®­ç»ƒæ•™ç¨‹](../doc/doc_ch/recognition.md)ï¼ŒæŒ‰ç…§è®­ç»ƒæ•°æ®æ ¼å¼å‡†å¤‡æ•°æ®ï¼Œå¹¶å®Œæˆè¯¥åœºæ™¯ä¸‹å‚ç±»æ–‡æœ¬è¯†åˆ«æ¨¡å‹çš„å¾®è°ƒè¿‡ç¨‹ã€‚

### 4.3 è¯­ä¹‰å®ä½“è¯†åˆ« ï¼ˆSemantic Entity Recognitionï¼‰

è¯­ä¹‰å®ä½“è¯†åˆ«æŒ‡çš„æ˜¯ç»™å®šä¸€æ®µæ–‡æœ¬è¡Œï¼Œç¡®å®šå…¶ç±»åˆ«ï¼ˆå¦‚`å§“å`ã€`ä½å€`ç­‰ç±»åˆ«ï¼‰ã€‚PaddleOCRä¸­æä¾›äº†åŸºäºVI-LayoutXLMçš„å¤šæ¨¡æ€è¯­ä¹‰å®ä½“è¯†åˆ«æ–¹æ³•ï¼Œèåˆæ–‡æœ¬ã€ä½ç½®ä¸ç‰ˆé¢ä¿¡æ¯ï¼Œç›¸æ¯”LayoutXLMå¤šæ¨¡æ€æ¨¡å‹ï¼Œå»é™¤äº†å…¶ä¸­çš„è§†è§‰éª¨å¹²ç½‘ç»œç‰¹å¾æå–éƒ¨åˆ†ï¼Œå¼•å…¥ç¬¦åˆé˜…è¯»é¡ºåºçš„æ–‡æœ¬è¡Œæ’åºæ–¹æ³•ï¼ŒåŒæ—¶ä½¿ç”¨UDMLè”åˆäº’è’¸é¦æ–¹æ³•è¿›è¡Œè®­ç»ƒï¼Œæœ€ç»ˆåœ¨ç²¾åº¦ä¸é€Ÿåº¦æ–¹é¢å‡è¶…è¶ŠLayoutXLMã€‚æ›´å¤šå…³äºVI-LayoutXLMçš„ç®—æ³•ä»‹ç»ä¸ç²¾åº¦æŒ‡æ ‡ï¼Œè¯·å‚è€ƒï¼š[VI-LayoutXLMç®—æ³•ä»‹ç»](../doc/doc_ch/algorithm_kie_vi_layoutxlm.md)ã€‚

#### 4.3.1 å‡†å¤‡æ•°æ®

å‘ç¥¨åœºæ™¯ä¸ºä¾‹ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æ ‡æ³¨å‡ºå…¶ä¸­çš„å…³é”®å­—æ®µï¼Œæˆ‘ä»¬å°†å…¶æ ‡æ³¨ä¸º`é—®é¢˜-ç­”æ¡ˆ`çš„key-value pairï¼Œå¦‚ä¸‹ï¼Œç¼–å·Noä¸º12270830ï¼Œåˆ™`No`å­—æ®µæ ‡æ³¨ä¸ºquestionï¼Œ`12270830`å­—æ®µæ ‡æ³¨ä¸ºanswerã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

<div align="center">
    <img src="https://user-images.githubusercontent.com/14270174/185381131-76b6e260-04fe-46d9-baca-6bdd7fe0d0ce.jpg" width="800">
</div>

**æ³¨æ„ï¼š**

* å¦‚æœæ–‡æœ¬æ£€æµ‹æ¨¡å‹æ•°æ®æ ‡æ³¨è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰æ ‡æ³¨ **éå…³é”®ä¿¡æ¯å†…å®¹** çš„æ£€æµ‹æ¡†ï¼Œé‚£ä¹ˆåœ¨æ ‡æ³¨å…³é”®ä¿¡æ¯æŠ½å–ä»»åŠ¡çš„æ—¶å€™ï¼Œä¹Ÿä¸éœ€è¦æ ‡æ³¨è¯¥éƒ¨åˆ†ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼›å¦‚æœæ ‡æ³¨çš„è¿‡ç¨‹ï¼Œå¦‚æœåŒæ—¶æ ‡æ³¨äº†**éå…³é”®ä¿¡æ¯å†…å®¹** çš„æ£€æµ‹æ¡†ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å°†è¯¥éƒ¨åˆ†çš„labelè®°ä¸ºotherã€‚
* æ ‡æ³¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä»¥æ–‡æœ¬è¡Œä¸ºå•ä½è¿›è¡Œæ ‡æ³¨ï¼Œæ— éœ€æ ‡æ³¨å•ä¸ªå­—ç¬¦çš„ä½ç½®ä¿¡æ¯ã€‚


å·²ç»å¤„ç†å¥½çš„å¢å€¼ç¨å‘ç¥¨æ•°æ®é›†ä»è¿™é‡Œä¸‹è½½ï¼š[å¢å€¼ç¨å‘ç¥¨æ•°æ®é›†ä¸‹è½½é“¾æ¥](https://aistudio.baidu.com/aistudio/datasetdetail/165561)ã€‚

ä¸‹è½½å¥½å‘ç¥¨æ•°æ®é›†ï¼Œå¹¶è§£å‹åœ¨train_dataç›®å½•ä¸‹ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºã€‚

```
train_data
  |--zzsfp
       |---class_list.txt
       |---imgs/
       |---train.json
       |---val.json
```

å…¶ä¸­`class_list.txt`æ˜¯åŒ…å«`other`, `question`, `answer`ï¼Œ3ä¸ªç§ç±»çš„çš„ç±»åˆ«åˆ—è¡¨ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ï¼Œ`imgs`ç›®å½•åº•ä¸‹ï¼Œ`train.json`ä¸`val.json`åˆ†åˆ«è¡¨ç¤ºè®­ç»ƒä¸è¯„ä¼°é›†åˆçš„æ ‡æ³¨æ–‡ä»¶ã€‚è®­ç»ƒé›†ä¸­åŒ…å«30å¼ å›¾ç‰‡ï¼ŒéªŒè¯é›†ä¸­åŒ…å«8å¼ å›¾ç‰‡ã€‚éƒ¨åˆ†æ ‡æ³¨å¦‚ä¸‹æ‰€ç¤ºã€‚

```py
b33.jpg [{"transcription": "No", "label": "question", "points": [[2882, 472], [3026, 472], [3026, 588], [2882, 588]], }, {"transcription": "12269563", "label": "answer", "points": [[3066, 448], [3598, 448], [3598, 576], [3066, 576]], ]}]
```

ç›¸æ¯”äºOCRæ£€æµ‹çš„æ ‡æ³¨ï¼Œä»…å¤šäº†`label`å­—æ®µã€‚


#### 4.3.2 å¼€å§‹è®­ç»ƒ


VI-LayoutXLMçš„é…ç½®ä¸º[ser_vi_layoutxlm_xfund_zh_udml.yml](../configs/kie/vi_layoutxlm/ser_vi_layoutxlm_xfund_zh_udml.yml)ï¼Œéœ€è¦ä¿®æ”¹æ•°æ®ã€ç±»åˆ«æ•°ç›®ä»¥åŠé…ç½®æ–‡ä»¶ã€‚

```yml
Architecture:
  model_type: &model_type "kie"
  name: DistillationModel
  algorithm: Distillation
  Models:
    Teacher:
      pretrained:
      freeze_params: false
      return_all_feats: true
      model_type: *model_type
      algorithm: &algorithm "LayoutXLM"
      Transform:
      Backbone:
        name: LayoutXLMForSer
        pretrained: True
        # one of base or vi
        mode: vi
        checkpoints:
        # å®šä¹‰ç±»åˆ«æ•°ç›®
        num_classes: &num_classes 5
   ...

PostProcess:
  name: DistillationSerPostProcess
  model_name: ["Student", "Teacher"]
  key: backbone_out
  # å®šä¹‰ç±»åˆ«æ–‡ä»¶
  class_path: &class_path train_data/zzsfp/class_list.txt

Train:
  dataset:
    name: SimpleDataSet
    # å®šä¹‰è®­ç»ƒæ•°æ®ç›®å½•ä¸æ ‡æ³¨æ–‡ä»¶
    data_dir: train_data/zzsfp/imgs
    label_file_list:
      - train_data/zzsfp/train.json
  ...

Eval:
  dataset:
    # å®šä¹‰è¯„ä¼°æ•°æ®ç›®å½•ä¸æ ‡æ³¨æ–‡ä»¶
    name: SimpleDataSet
    data_dir: train_data/zzsfp/imgs
    label_file_list:
      - train_data/zzsfp/val.json
  ...
```

LayoutXLMä¸VI-LayoutXLMé’ˆå¯¹è¯¥åœºæ™¯çš„è®­ç»ƒç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚

| æ¨¡å‹ | è¿­ä»£è½®æ•° | Hmean |
| :---: | :---: | :---: |
| LayoutXLM | 50 | 100% |
| VI-LayoutXLM | 50 | 100% |

å¯ä»¥çœ‹å‡ºï¼Œç”±äºå½“å‰æ•°æ®é‡è¾ƒå°‘ï¼Œåœºæ™¯æ¯”è¾ƒç®€å•ï¼Œå› æ­¤2ä¸ªæ¨¡å‹çš„Hmeanå‡è¾¾åˆ°äº†100%ã€‚


#### 4.3.3 æ¨¡å‹è¯„ä¼°

æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨çš„æ˜¯çŸ¥è¯†è’¸é¦çš„ç­–ç•¥ï¼Œæœ€ç»ˆä¿ç•™äº†å­¦ç”Ÿæ¨¡å‹çš„å‚æ•°ï¼Œåœ¨è¯„ä¼°æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é’ˆå¯¹å­¦ç”Ÿæ¨¡å‹çš„é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹: [ser_vi_layoutxlm_xfund_zh.yml](../configs/kie/vi_layoutxlm/ser_vi_layoutxlm_xfund_zh.yml)ï¼Œä¿®æ”¹å†…å®¹ä¸è®­ç»ƒé…ç½®ç›¸åŒï¼ŒåŒ…æ‹¬**ç±»åˆ«æ•°ã€ç±»åˆ«æ˜ å°„æ–‡ä»¶ã€æ•°æ®ç›®å½•**ã€‚

ä¿®æ”¹å®Œæˆåï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å®Œæˆè¯„ä¼°è¿‡ç¨‹ã€‚

```bash
# æ³¨æ„ï¼šéœ€è¦æ ¹æ®ä½ çš„é…ç½®æ–‡ä»¶åœ°å€ä¸ä¿å­˜çš„æ¨¡å‹åœ°å€ï¼Œå¯¹è¯„ä¼°å‘½ä»¤è¿›è¡Œä¿®æ”¹
python3 tools/eval.py -c ./fapiao/ser_vi_layoutxlm.yml -o Architecture.Backbone.checkpoints=fapiao/models/ser_vi_layoutxlm_fapiao_udml/best_accuracy
```

è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚

```
[2022/08/18 08:49:58] ppocr INFO: metric eval ***************
[2022/08/18 08:49:58] ppocr INFO: precision:1.0
[2022/08/18 08:49:58] ppocr INFO: recall:1.0
[2022/08/18 08:49:58] ppocr INFO: hmean:1.0
[2022/08/18 08:49:58] ppocr INFO: fps:1.9740402401574881
```

#### 4.3.4 æ¨¡å‹é¢„æµ‹

ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œé¢„æµ‹ã€‚

```bash
python3 tools/infer_kie_token_ser.py -c fapiao/ser_vi_layoutxlm.yml -o Architecture.Backbone.checkpoints=fapiao/models/ser_vi_layoutxlm_fapiao_udml/best_accuracy Global.infer_img=./train_data/XFUND/zh_val/val.json Global.infer_mode=False
```

é¢„æµ‹ç»“æœä¼šä¿å­˜åœ¨é…ç½®æ–‡ä»¶ä¸­çš„`Global.save_res_path`ç›®å½•ä¸­ã€‚

éƒ¨åˆ†é¢„æµ‹ç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚

<div align="center">
    <img src="https://user-images.githubusercontent.com/14270174/185310636-6ce02f7c-790d-479f-b163-ea97a5a04808.jpg" width="800">
</div>


* æ³¨æ„ï¼šåœ¨é¢„æµ‹æ—¶ï¼Œä½¿ç”¨çš„æ–‡æœ¬æ£€æµ‹ä¸è¯†åˆ«ç»“æœä¸ºæ ‡æ³¨çš„ç»“æœï¼Œç›´æ¥ä»jsonæ–‡ä»¶é‡Œé¢è¿›è¡Œè¯»å–ã€‚

å¦‚æœå¸Œæœ›ä½¿ç”¨OCRå¼•æ“ç»“æœå¾—åˆ°çš„ç»“æœè¿›è¡Œæ¨ç†ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œæ¨ç†ã€‚


```bash
python3 tools/infer_kie_token_ser.py -c fapiao/ser_vi_layoutxlm.yml -o Architecture.Backbone.checkpoints=fapiao/models/ser_vi_layoutxlm_fapiao_udml/best_accuracy Global.infer_img=./train_data/zzsfp/imgs/b25.jpg Global.infer_mode=True
```

ç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚

<div align="center">
    <img src="https://user-images.githubusercontent.com/14270174/185384321-61153faa-e407-45c4-8e7c-a39540248189.jpg" width="800">
</div>

å®ƒä¼šä½¿ç”¨PP-OCRv3çš„æ–‡æœ¬æ£€æµ‹ä¸è¯†åˆ«æ¨¡å‹è¿›è¡Œè·å–æ–‡æœ¬ä½ç½®ä¸å†…å®¹ä¿¡æ¯ã€‚

å¯ä»¥çœ‹å‡ºï¼Œç”±äºè®­ç»ƒçš„è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰æ ‡æ³¨é¢å¤–çš„å­—æ®µä¸ºotherç±»åˆ«ï¼Œæ‰€ä»¥å¤§å¤šæ•°æ£€æµ‹å‡ºæ¥çš„å­—æ®µè¢«é¢„æµ‹ä¸ºquestionæˆ–è€…answerã€‚

å¦‚æœå¸Œæœ›æ„å»ºåŸºäºä½ åœ¨å‚ç±»åœºæ™¯è®­ç»ƒå¾—åˆ°çš„OCRæ£€æµ‹ä¸è¯†åˆ«æ¨¡å‹ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•ä¼ å…¥æ£€æµ‹ä¸è¯†åˆ«çš„inference æ¨¡å‹è·¯å¾„ï¼Œå³å¯å®ŒæˆOCRæ–‡æœ¬æ£€æµ‹ä¸è¯†åˆ«ä»¥åŠSERçš„ä¸²è”è¿‡ç¨‹ã€‚

```bash
python3 tools/infer_kie_token_ser.py -c fapiao/ser_vi_layoutxlm.yml -o Architecture.Backbone.checkpoints=fapiao/models/ser_vi_layoutxlm_fapiao_udml/best_accuracy Global.infer_img=./train_data/zzsfp/imgs/b25.jpg Global.infer_mode=True Global.kie_rec_model_dir="your_rec_model" Global.kie_det_model_dir="your_det_model"
```

### 4.4 å…³ç³»æŠ½å–ï¼ˆRelation Extractionï¼‰

ä½¿ç”¨SERæ¨¡å‹ï¼Œå¯ä»¥è·å–å›¾åƒä¸­æ‰€æœ‰çš„questionä¸answerçš„å­—æ®µï¼Œç»§ç»­è¿™äº›å­—æ®µçš„ç±»åˆ«ï¼Œæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥è·å–questionä¸answerä¹‹é—´çš„è¿æ¥ï¼Œå› æ­¤éœ€è¦è¿›ä¸€æ­¥è®­ç»ƒå…³ç³»æŠ½å–æ¨¡å‹ï¼Œè§£å†³è¯¥é—®é¢˜ã€‚æœ¬æ–‡ä¹ŸåŸºäºVI-LayoutXLMå¤šæ¨¡æ€é¢„è®­ç»ƒæ¨¡å‹ï¼Œè¿›è¡Œä¸‹æ¸¸REä»»åŠ¡çš„æ¨¡å‹è®­ç»ƒã€‚

#### 4.4.1 å‡†å¤‡æ•°æ®

ä»¥å‘ç¥¨åœºæ™¯ä¸ºä¾‹ï¼Œç›¸æ¯”äºSERä»»åŠ¡ï¼ŒREä¸­è¿˜éœ€è¦æ ‡è®°æ¯ä¸ªæ–‡æœ¬è¡Œçš„idä¿¡æ¯ä»¥åŠé“¾æ¥å…³ç³»linkingï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

<div align="center">
    <img src="https://user-images.githubusercontent.com/14270174/185387870-dc9125a0-9ceb-4036-abf3-184b6e65dc7d.jpg" width="800">
</div>


æ ‡æ³¨æ–‡ä»¶çš„éƒ¨åˆ†å†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚

```py
b33.jpg [{"transcription": "No", "label": "question", "points": [[2882, 472], [3026, 472], [3026, 588], [2882, 588]], "id": 0, "linking": [[0, 1]]}, {"transcription": "12269563", "label": "answer", "points": [[3066, 448], [3598, 448], [3598, 576], [3066, 576]], "id": 1, "linking": [[0, 1]]}]
```

ç›¸æ¯”ä¸SERçš„æ ‡æ³¨ï¼Œå¤šäº†`id`ä¸`linking`çš„ä¿¡æ¯ï¼Œåˆ†åˆ«è¡¨ç¤ºå”¯ä¸€æ ‡è¯†ä»¥åŠè¿æ¥å…³ç³»ã€‚

å·²ç»å¤„ç†å¥½çš„å¢å€¼ç¨å‘ç¥¨æ•°æ®é›†ä»è¿™é‡Œä¸‹è½½ï¼š[å¢å€¼ç¨å‘ç¥¨æ•°æ®é›†ä¸‹è½½é“¾æ¥](https://aistudio.baidu.com/aistudio/datasetdetail/165561)ã€‚

#### 4.4.2 å¼€å§‹è®­ç»ƒ

åŸºäºVI-LayoutXLMçš„REä»»åŠ¡é…ç½®ä¸º[re_vi_layoutxlm_xfund_zh_udml.yml](../configs/kie/vi_layoutxlm/re_vi_layoutxlm_xfund_zh_udml.yml)ï¼Œéœ€è¦ä¿®æ”¹**æ•°æ®è·¯å¾„ã€ç±»åˆ«åˆ—è¡¨æ–‡ä»¶**ã€‚

```yml
Train:
  dataset:
    name: SimpleDataSet
    # å®šä¹‰è®­ç»ƒæ•°æ®ç›®å½•ä¸æ ‡æ³¨æ–‡ä»¶
    data_dir: train_data/zzsfp/imgs
    label_file_list:
      - train_data/zzsfp/train.json
    transforms:
      - DecodeImage: # load image
          img_mode: RGB
          channel_first: False
      - VQATokenLabelEncode: # Class handling label
          contains_re: True
          algorithm: *algorithm
          class_path: &class_path train_data/zzsfp/class_list.txt
  ...

Eval:
  dataset:
    # å®šä¹‰è¯„ä¼°æ•°æ®ç›®å½•ä¸æ ‡æ³¨æ–‡ä»¶
    name: SimpleDataSet
    data_dir: train_data/zzsfp/imgs
    label_file_list:
      - train_data/zzsfp/val.json
  ...

```

LayoutXLMä¸VI-LayoutXLMé’ˆå¯¹è¯¥åœºæ™¯çš„è®­ç»ƒç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚

| æ¨¡å‹ | è¿­ä»£è½®æ•° | Hmean |
| :---: | :---: | :---: |
| LayoutXLM | 50 | 98.0% |
| VI-LayoutXLM | 50 | 99.3% |

å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºVI-LayoutXLMç›¸æ¯”LayoutXLMçš„Hmeané«˜äº†1.3%ã€‚

å¦‚éœ€è·å–å·²è®­ç»ƒæ¨¡å‹ï¼Œè¯·æ‰«ç å¡«å†™é—®å·ï¼ŒåŠ å…¥PaddleOCRå®˜æ–¹äº¤æµç¾¤è·å–å…¨éƒ¨OCRå‚ç±»æ¨¡å‹ä¸‹è½½é“¾æ¥ã€ã€ŠåŠ¨æ‰‹å­¦OCRã€‹ç”µå­ä¹¦ç­‰å…¨å¥—OCRå­¦ä¹ èµ„æ–™ğŸ

<div align="center">
<img src="https://ai-studio-static-online.cdn.bcebos.com/dd721099bd50478f9d5fb13d8dd00fad69c22d6848244fd3a1d3980d7fefc63e"  width = "150" height = "150" />
</div>


#### 4.4.3 æ¨¡å‹è¯„ä¼°

æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨çš„æ˜¯çŸ¥è¯†è’¸é¦çš„ç­–ç•¥ï¼Œæœ€ç»ˆä¿ç•™äº†å­¦ç”Ÿæ¨¡å‹çš„å‚æ•°ï¼Œåœ¨è¯„ä¼°æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é’ˆå¯¹å­¦ç”Ÿæ¨¡å‹çš„é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹: [re_vi_layoutxlm_xfund_zh.yml](../configs/kie/vi_layoutxlm/re_vi_layoutxlm_xfund_zh.yml)ï¼Œä¿®æ”¹å†…å®¹ä¸è®­ç»ƒé…ç½®ç›¸åŒï¼ŒåŒ…æ‹¬**ç±»åˆ«æ˜ å°„æ–‡ä»¶ã€æ•°æ®ç›®å½•**ã€‚

ä¿®æ”¹å®Œæˆåï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å®Œæˆè¯„ä¼°è¿‡ç¨‹ã€‚

```bash
# æ³¨æ„ï¼šéœ€è¦æ ¹æ®ä½ çš„é…ç½®æ–‡ä»¶åœ°å€ä¸ä¿å­˜çš„æ¨¡å‹åœ°å€ï¼Œå¯¹è¯„ä¼°å‘½ä»¤è¿›è¡Œä¿®æ”¹
python3 tools/eval.py -c ./fapiao/re_vi_layoutxlm.yml -o Architecture.Backbone.checkpoints=fapiao/models/re_vi_layoutxlm_fapiao_udml/best_accuracy
```

è¾“å‡ºç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚

```py
[2022/08/18 12:17:14] ppocr INFO: metric eval ***************
[2022/08/18 12:17:14] ppocr INFO: precision:1.0
[2022/08/18 12:17:14] ppocr INFO: recall:0.9873417721518988
[2022/08/18 12:17:14] ppocr INFO: hmean:0.9936305732484078
[2022/08/18 12:17:14] ppocr INFO: fps:2.765963539771157
```

#### 4.4.4 æ¨¡å‹é¢„æµ‹

ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œé¢„æµ‹ã€‚

```bash
# -c åé¢çš„æ˜¯REä»»åŠ¡çš„é…ç½®æ–‡ä»¶
# -o åé¢çš„å­—æ®µæ˜¯REä»»åŠ¡çš„é…ç½®
# -c_ser åé¢çš„æ˜¯SERä»»åŠ¡çš„é…ç½®æ–‡ä»¶
# -c_ser åé¢çš„å­—æ®µæ˜¯SERä»»åŠ¡çš„é…ç½®
python3 tools/infer_kie_token_ser_re.py -c fapiao/re_vi_layoutxlm.yml -o Architecture.Backbone.checkpoints=fapiao/models/re_vi_layoutxlm_fapiao_trained/best_accuracy Global.infer_img=./train_data/zzsfp/val.json Global.infer_mode=False -c_ser fapiao/ser_vi_layoutxlm.yml -o_ser Architecture.Backbone.checkpoints=fapiao/models/ser_vi_layoutxlm_fapiao_trained/best_accuracy
```

é¢„æµ‹ç»“æœä¼šä¿å­˜åœ¨é…ç½®æ–‡ä»¶ä¸­çš„`Global.save_res_path`ç›®å½•ä¸­ã€‚

éƒ¨åˆ†é¢„æµ‹ç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚

<div align="center">
    <img src="https://user-images.githubusercontent.com/14270174/185393805-c67ff571-cf7e-4217-a4b0-8b396c4f22bb.jpg" width="800">
</div>


* æ³¨æ„ï¼šåœ¨é¢„æµ‹æ—¶ï¼Œä½¿ç”¨çš„æ–‡æœ¬æ£€æµ‹ä¸è¯†åˆ«ç»“æœä¸ºæ ‡æ³¨çš„ç»“æœï¼Œç›´æ¥ä»jsonæ–‡ä»¶é‡Œé¢è¿›è¡Œè¯»å–ã€‚

å¦‚æœå¸Œæœ›ä½¿ç”¨OCRå¼•æ“ç»“æœå¾—åˆ°çš„ç»“æœè¿›è¡Œæ¨ç†ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œæ¨ç†ã€‚

```bash
python3 tools/infer_kie_token_ser_re.py -c fapiao/re_vi_layoutxlm.yml -o Architecture.Backbone.checkpoints=fapiao/models/re_vi_layoutxlm_fapiao_udml/best_accuracy Global.infer_img=./train_data/zzsfp/val.json Global.infer_mode=True -c_ser fapiao/ser_vi_layoutxlm.yml -o_ser Architecture.Backbone.checkpoints=fapiao/models/ser_vi_layoutxlm_fapiao_udml/best_accuracy
```

å¦‚æœå¸Œæœ›æ„å»ºåŸºäºä½ åœ¨å‚ç±»åœºæ™¯è®­ç»ƒå¾—åˆ°çš„OCRæ£€æµ‹ä¸è¯†åˆ«æ¨¡å‹ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•ä¼ å…¥ï¼Œå³å¯å®ŒæˆSER + REçš„ä¸²è”è¿‡ç¨‹ã€‚

```bash
python3 tools/infer_kie_token_ser_re.py -c fapiao/re_vi_layoutxlm.yml -o Architecture.Backbone.checkpoints=fapiao/models/re_vi_layoutxlm_fapiao_udml/best_accuracy Global.infer_img=./train_data/zzsfp/val.json Global.infer_mode=True -c_ser fapiao/ser_vi_layoutxlm.yml -o_ser Architecture.Backbone.checkpoints=fapiao/models/ser_vi_layoutxlm_fapiao_udml/best_accuracy Global.kie_rec_model_dir="your_rec_model" Global.kie_det_model_dir="your_det_model"
```
