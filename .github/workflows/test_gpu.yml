name: PaddleOCR PR Tests GPU

on:
  push:
    branches: ["main", "release/*"]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '**.yml'
      - '**.yaml'
  pull_request:
    branches: ["main", "release/*"]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '**.yml'
      - '**.yaml'
  workflow_dispatch:
env:
  PR_ID: ${{ github.event.pull_request.number }}
  COMMIT_ID: ${{ github.event.pull_request.head.sha }}
  work_dir: /workspace/PaddleOCR
  PADDLENLP_ROOT: /workspace/PaddleOCR
  TASK: paddleocr-CI-${{ github.event.pull_request.number }}
  BRANCH: ${{ github.event.pull_request.base.ref }}
  AGILE_COMPILE_BRANCH: ${{ github.event.pull_request.base.ref }}
permissions:
  contents: read

jobs:
  test-pr:
    runs-on: self-hosted  # ✅ 使用自托管 runner
    # container:            # ✅ 使用容器执行步骤
    #   image: ccr-2vdh3abv-pub.cnc.bj.baidubce.com/paddlepaddle/paddle:latest-dev-cuda11.8-cudnn8.6-trt8.5-gcc82
    #   options: --ipc=host # 可选，防止深度学习框架内存通信问题（如需要）

    steps:
      - name: check env
        run: |
          echo ${PR_ID}
          echo ${COMMIT_ID}
          echo ${TASK}
          echo ${BRANCH}
          echo ${AGILE_COMPILE_BRANCH}
      - name: Upgrade pip and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          python -m pip install paddlepaddle==3.0.0 -i https://www.paddlepaddle.org.cn/packages/stable/cpu/
          pip install -e .

      - name: Test with pytest
        run: |
          pytest --verbose tests/
