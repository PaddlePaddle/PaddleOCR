name: PaddleOCR PR Tests GPU

on:
  push:
    branches: ["main", "release/*"]
    paths-ignore:
      - '**.md'
      - '**.txt'
 #     - '**.yml'
      - '**.yaml'
  pull_request:
    branches: ["main", "release/*"]
    paths-ignore:
      - '**.md'
      - '**.txt'
#      - '**.yml'
      - '**.yaml'
  workflow_dispatch:
env:
  PR_ID: ${{ github.event.pull_request.number }}
  COMMIT_ID: ${{ github.event.pull_request.head.sha }}
  work_dir: /workspace/PaddleOCR
  PADDLENLP_ROOT: /workspace/PaddleOCR
  TASK: paddleocr-CI-${{ github.event.pull_request.number }}
  BRANCH: ${{ github.event.pull_request.base.ref }}
  AGILE_COMPILE_BRANCH: ${{ github.event.pull_request.base.ref }}
  DIR_NAME: ${{ github.repository }}
permissions:
  contents: read

jobs:
  tar2cloud:
    runs-on: ubuntu-latest
    steps:
      - name: clone and fetch
        run: |
          git clone https://github.com/PaddlePaddle/PaddleOCR.git
          cd PaddleOCR
          git fetch origin pull/${PR_ID}/head:ci_build
          git checkout ci_build
          cd ../
          tar cf PaddleOCR.tar PaddleOCR

      - name: Upload
        env:
          AK: ${{ secrets.BOS_AK }}
          SK: ${{ secrets.BOS_SK }}
        run: |
          if [ -z "$AK" ] || [ -z "$SK" ]; then
            echo "Error: AK or SK is not set."
            exit 1
          else
            echo "AK and SK are set."
          fi

          python -m pip install bce-python-sdk==0.8.74
          wget -q --no-proxy https://xly-devops.bj.bcebos.com/home/bos_new.tar.gz
          tar xf bos_new.tar.gz
          ls
          python BosClient.py PaddleOCR.tar paddle-qa/PaddleOCR/pr/${PR_ID}
          
  test-pr:
    needs: tar2cloud
    runs-on: self-hosted
    steps:
      - name: check env
        run: |
          echo ${PR_ID}
          echo ${COMMIT_ID}
          echo ${TASK}
          echo ${BRANCH}
          echo ${AGILE_COMPILE_BRANCH}
          echo ${DIR_NAME}
          
      - name: get code
        run: |
          wget -q https://paddle-qa.bj.bcebos.com/PaddleOCR/pr/${PR_ID}/PaddleOCR.tar
          tar xf PaddleOCR.tar
          cd PaddleOCR
          git log

          
      # - name: Upgrade pip and install dependencies
      #   run: |
      #     python -m pip install --upgrade pip
      #     pip install pytest
      #     if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      #     python -m pip install paddlepaddle==3.0.0 -i https://www.paddlepaddle.org.cn/packages/stable/cpu/
      #     pip install -e .

      # - name: Test with pytest
      #   run: |
      #     pytest --verbose tests/
