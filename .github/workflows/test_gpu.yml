name: PaddleOCR PR Tests

on:
  push:
    branches: ["main", "release/*"]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '**.yml'
      - '**.yaml'
  pull_request:
    branches: ["main", "release/*"]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '**.yml'
      - '**.yaml'

permissions:
  contents: read

jobs:
  test-pr:
    runs-on: self-hosted  # ✅ 使用自托管 runner
    container:            # ✅ 使用容器执行步骤
      image: ccr-2vdh3abv-pub.cnc.bj.baidubce.com/paddlepaddle/paddle:latest-dev-cuda11.8-cudnn8.6-trt8.5-gcc82
      options: --ipc=host # 可选，防止深度学习框架内存通信问题（如需要）

    steps:
      - uses: actions/checkout@v4

      - name: Upgrade pip and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          python -m pip install paddlepaddle==3.0.0 -i https://www.paddlepaddle.org.cn/packages/stable/cpu/
          pip install -e .

      - name: Test with pytest
        run: |
          pytest --verbose tests/
